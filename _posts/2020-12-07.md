---
layout: post
title: Subnets
category: dev
lang: jp
emoji: "ğŸ¦Œ"
---

ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã®ç•°ãªã‚‹ã‚µãƒ–ãƒãƒƒãƒˆé–“ã§é€šä¿¡ã™ã‚‹
### æ¡ä»¶
æ§‹æˆã™ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯3ã¤ã®IP-subet ã§æ§‹æˆã•ã‚Œã€A, B, Cã¨ã™ã‚‹ã€‚ 
  1. Aã¨Cã¯ç›´æ¥é€šä¿¡å‡ºæ¥ããªã„
  1. Bã¯Aã¨Cã¨é€šä¿¡ã§ãã‚‹ï¼ˆåŒã˜IP-subnetã«å±ã™ã‚‹IFã‚’æŒã¤ï¼‰ 

### æ‰‹é †
1. Virtual boxã‚’ä½¿ç”¨ã—ã€ãƒ›ã‚¹ãƒˆA, B, Cã‚’æ§‹ç¯‰ã™ã‚‹
2. ABé–“ã€BCé–“ã«ãã‚Œãã‚ŒInternal Networkã‚’æ§‹ç¯‰ã™ã‚‹ã€€(Aã¨B, Bã¨Cã‚’æ¥ç¶š)

### ç’°å¢ƒ
- VirtualBox: 6.1.16
- Ubuntu: 18.04.5 LTS

#### 1. Virtual Boxã‚’ä½¿ç”¨ã—ãƒ›ã‚¹ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹
1. PCä¸Šã§ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã®ã§ã¾ãšã¯Virtual Boxã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ 
    Ubuntu18.04ä»¥é™ã§ã¯APTãƒ¬ãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¯èƒ½ãªã®ã§ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ä¸Šã§ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™:
    ``` shell
    sudo apt install virtualbox
    ```
    [ãã®ä»–ã®ç’°å¢ƒã§ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã“ã¡ã‚‰ã‚’å‚ç…§][installingvirtualbox]

2. Virtual Boxä¸Šã«VM A, B, Cã‚’æ§‹ç¯‰
    - æ–°ãŸã«æ§‹ç¯‰ã™ã‚‹VMã‚’Aã¨ã—ã€é©å½“ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ãƒ¡ãƒ¢ãƒªã®å®¹é‡ã‚’å‰²ã‚Šå½“ã¦ã¾ã™
       - ã“ã“ã§ã¯[Ubuntu 20.04.1][ubuntu20]ã®isoã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ 
       - è©³ã—ã„VMã®èµ·å‹•æ–¹æ³•ã«é–¢ã—ã¦ã¯[ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§][createvms]
    - AãŒæ­£å¸¸ã«èµ·å‹•ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ä¸€åº¦ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã¾ã™
    - ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãŒå®Œäº†ã—æ¬¡ç¬¬ã€Aã®è¨­å®šã‹ã‚‰ç‹¬ç«‹ã—ãŸã‚¯ãƒ­ãƒ¼ãƒ³ã‚’äºŒã¤ä½œæˆã—ã€B, Cã¨ã—ã¾ã™

#### 2. ABé–“ã€BCé–“ã«ãã‚Œãã‚Œå†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ§‹ç¯‰ã™ã‚‹
IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ä¸‹å›³ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚
![](/assets/images/subnets.png)

- æ¡ä»¶ã‚ˆã‚ŠAã¯Bã¨ç›´æ¥é€šä¿¡ãŒã§ãã¾ã™ã€‚ã‚ˆã£ã¦ãã®ãŸã‚ã®IFã®æ§‹ç¯‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™  
  è¨­å®šã®æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
     1. VirtualBoxä¸Šã§Aâ†’Settingsâ†’Networkã‚’é¸æŠ  
     1. Adapter2ä¸Šã®Enable Network Adapterã‚’æœ‰åŠ¹ã«ã™ã‚‹  
     1. Attached toã‚’Internal Networkã‚’é¸æŠ  
     1. Nameã«`intnet-1`ã¨å…¥åŠ›ã™ã‚‹ (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å)
     1. Advancedã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®Promiscous Modeã‚’Allow VMsã«å¤‰æ›´ã—è¨­å®šã‚’å®Œäº†ã™ã‚‹
- Bã¯A, Cã¨ç›´æ¥çš„ãªé€šä¿¡ãŒå¯èƒ½ãªã®ã§äºŒã¤ã®IFãŒå¿…è¦ã§ã™  
     - Adapter2ã‚’æœ‰åŠ¹ã«ã—ã€Aã¨åŒæ§˜ã®è¨­å®šã‚’ã™ã‚‹
     - Adapter3ã‚’æœ‰åŠ¹ã«ã—ã€Nameã«`intnet-2`ã¨å…¥åŠ›ã™ã‚‹
- Cã«ãŠã„ã¦ã‚‚åŒæ§˜ã®è¨­å®šã‚’ã—ã€VitrualBoxä¸Šã§A, B, Cã‚’èµ·å‹•ã—ã¾ã™
- æ¬¡ã«ã€hostnameã‚’å¤‰æ›´ã—ã¾ã™
    Aä¸Šã§ã€`/etc/hostname`ã®å†…å®¹ã‚’  
    ```
    router-a
    ```
    ã«å¤‰æ›´ã—ã€`/etc/hosts`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚
    ```
    127.0.0.1 localhost
    127.0.0.1 router-a
    ```
    B, Cä¸Šã§ã‚‚åŒæ§˜ã«ã€ãã‚Œãã‚Œã«å¯¾å¿œã™ã‚‹ãƒ›ã‚¹ãƒˆãƒãƒ¼ãƒ ã«å¤‰æ›´ã—ã€å†èµ·å‹•ã—ã¾ã™ã€‚
- ä¸Šè¨˜ã®è¨­å®šã§è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã¯ãšã®IFã‚’ç¢ºèªã—ã¦ã¿ã¾ã™
    å„ãƒ›ã‚¹ãƒˆä¸Šã§
    ``` shell
    ifconfig -a
    ```
    ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®IF`enp0s3`ã®ä»–ã«ã€Aã¨Cä¸Šã§ã¯`enp0s8`ã€Bã§ã¯`enp0s8`ã¨`enp0s9`ãŒãƒªã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã è¿½åŠ ã•ã‚ŒãŸIFã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰²å½“ã¯ã•ã‚Œã¦ã„ãªã„ã¯ãšã§ã™ã€‚
- ç¶šã„ã¦ã€å„IFã«é™çš„ãªIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚Ubuntu18.04ã§ã¯[netplan]ã¨å‘¼ã°ã‚Œã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã—IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šãŒã§ãã¾ã™ã€‚å„ãƒ›ã‚¹ãƒˆä¸Šã®`etc/netplan/00-installer-config.yaml`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«æ°¸ç¶šçš„ãªè¨­å®šã®è¨˜è¿°ãŒå¯èƒ½ã§ã™(ç’°å¢ƒã«ã‚ˆã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«åãŒç•°ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„)ã€‚
    + A
      ```yaml
      # etc/netplan/00-installer-config.yaml
      # This is the network config written by 'subiquity'
      network:
        ethernets:
          enp0s3:
            dhcp4: true
          enp0s8:
            dhcp4: false
            addresses: [192.168.1.1/24]
            routes: 
                - to: 0.0.0.0/0 
                  via: 10.0.2.2
                  metric: 100
                - to: 192.168.2.0/24
                  via: 192.168.1.2
                  metric: 100
        version: 2
      ```
      ã“ã‚Œã¯ã€Œenp0s8ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’`192.168.1.1`ã€ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯ã‚’`255.255.255.0`ã«è¨­å®šã—ã€`192.168.2.0`å®›ã¦ã®ãƒ‘ã‚±ãƒƒãƒˆã¯`192.168.1.2`ã«ã€ã•ã‚‚ãªãã°`10.10.2.2`ã«è»¢é€ã™ã‚‹ã€ã‚’æ„å‘³ã—ã¾ã™ã€‚
    + B
      ```yaml
      # etc/netplan/00-installer-config.yaml
      # This is the network config written by 'subiquity'
      network:
        ethernets:
          enp0s3:
            dhcp4: true
          enp0s8:
            dhcp4: false
            addresses: [192.168.1.2/24]
            gateway4: 10.0.2.2
          enp0s9:
            dhcp4: false
            addresses: [192.168.2.2/24]
            gateway4: 10.0.2.2
        version: 2
      ```
      Bã§ã¯ç‰¹å®šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¦å®šã™ã‚‹å¿…è¦ãŒãªã„ã®ã§`enp0s8`ã¨`enp0s9`ã«å¯¾å¿œã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¨­å®šã®ã¿ã‚’è¡Œã„ã¾ã™ã€‚
    + C
      ```yaml
      # etc/netplan/00-installer-config.yaml
      # This is the network config written by 'subiquity'
      network:
        ethernets:
          enp0s3:
            dhcp4: true
          enp0s8:
            dhcp4: false
            addresses: [192.168.2.1/24]
            routes: 
                - to: 0.0.0.0/0 
                  via: 10.0.2.2
                  metric: 100
                - to: 192.168.1.0/24
                  via: 192.168.2.2
                  metric: 100
        version: 2
      ```
    ç·¨é›†ãŒå®Œäº†ã—ãŸã‚‰ã€å…¨ã¦ã®ãƒ›ã‚¹ãƒˆã‚’å†èµ·å‹•ã—ã¾ã™ã€‚
  - ä¸Šè¨˜ã®è¨­å®šãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†
    + A â†’ B:  
    Aä¸Šã§`ping -c 5 192.168.1.2`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
      ```
      --- 192.168.1.2 ping statistics ---
      5 packets transmitted, 5 received, 0% packet loss, time 4095ms
      rtt min/avg/max/mdev = 0.296/0.384/0.502/0.077 ms
      ```
    + C â†’ B:  
    Bä¸Šã§`ping -c 5 192.168.2.2`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
      ```
      --- 192.168.2.2 ping statistics ---
      5 packets transmitted, 5 received, 0% packet loss, time 4086ms
      rtt min/avg/max/mdev = 0.337/0.522/0.812/0.180 ms
      ```
    ABé–“ã€BCé–“ã¯å•é¡Œãªã•ãã†ã§ã™ã€‚
    + A â†’ C:  
    Aä¸Šã§`ping -c 5 192.168.2.1`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
      ```
      --- 192.168.2.1 ping statistics ---
      5 packets transmitted, 0 received, 100% packet loss, time 4071ms
      ```
      ãƒ‘ã‚±ãƒƒãƒˆãŒå±Šã„ã¦ãªã„ã‚ˆã†ã§ã™ã€‚ã“ã‚Œã¯ã€Linuxã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§IP ForwardingãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‰ã®ã‚ˆã†ã§ã™ã€‚Bä¸Šã§ãƒ‘ã‚±ãƒƒãƒˆãŒæ”¾æ£„ã•ã‚Œã¦ã„ã¾ã™ã€‚
      Bä¸Šã§Packet Forwardingã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€`/etc/sysctl.conf`ã®ã€
        ```conf
        # net.ipv4.ip_forward=1
        ```
      ã“ã®è¡Œã‚’ã‚¢ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã ã‘ã§ã™ã€‚
      Bã‚’å†èµ·å‹•ã—ã€å†åº¦Aä¸Šã§`ping -c 5 192.168.2.1`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
      ```
      --- 192.168.2.1 ping statistics ---
      5 packets transmitted, 5 received, 0% packet loss, time 4025ms
      rtt min/avg/max/mdev = 0.619/1.171/1.935/0.434 ms
      ```
      ç„¡äº‹ACé–“ã®ãƒ‘ã‚±ãƒƒãƒˆã®ã‚„ã‚Šå–ã‚ŠãŒç¢ºèªã§ãã¾ã—ãŸã€‚

[installingvirtualbox]: https://www.oracle.com/jp/virtualization/technologies/virtualbox/downloads.html
[createvms]: https://www.linuxmania.jp/virtualbox_01.html
[ubuntu20]: https://releases.ubuntu.com/20.04/ubuntu-20.04.1-live-server-amd64.iso
[netplan]: https://netplan.io/
