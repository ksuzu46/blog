---
layout: post
title: Claude Code
category: dev
lang: jp
emoji: '🤝'
---

## Claude Code でブログを改修した

> このエントリは、これまでにこのブログで書いてきた記事を Claude Code に読み込ませ、
> 「自分っぽい作業記録を書いてほしい」と頼んで書かせたものである。  
> ブログの改修とあわせて、AI を使った執筆の一例として残しておく。

前回このブログについて書いたのは 2020 年の秋で、気づけばもう 5 年以上前になる。当時は Next.js に初めて触れて「すばらしく静的なサイトが完成した」みたいなことを書いていた気がする。
今読み返すと若干むず痒い。

あれから Next.js も自分もそれなりに変わった。
Pages Router は App Router になり、JavaScript は TypeScript に置き換わり、自分も学生からエンジニアになった。

……のに、このブログだけはあの頃のまま放置されていた。

年明けにふと「いい加減どうにかするか」と思い立って、ブログのモダナイズをすることにした。
ただ、今回は一人で黙々とやるのではなく、最近よく使っている [Claude Code][claude-code] に手伝ってもらうことにした。

Claude Code は普段から使っているツールなので特別な期待があったわけではないが、今回のブログ改修では思った以上にハマった。

せっかくなので、何をやったかをまとめておく。

### モダナイゼーション

まずは土台から。

既存のコードベースは
**JavaScript + Pages Router + 素の CSS** という、2020 年当時の Next.js そのものだった。
これを、だいたい次の順番で書き換えた。

1. **TypeScript 化**
   `.js` を `.ts` / `.tsx` に変換して、最低限の型を入れる
2. **Markdown パイプライン刷新**
   GitHub REST API 経由のレンダリングをやめて `unified` / `remark` / `rehype` に切り替え
3. **CSS Modules + SCSS**
   グローバル CSS をやめて `.module.scss` に分割
4. **App Router 移行**
   `pages/` → `app/` へ。`getStaticProps` が消えてただの `async` 関数になるやつ
5. **`next/image` 対応**
   `<img>` を `Image` コンポーネントに置き換え
   （`output: 'export'` なので `unoptimized: true`）

Claude Code にリポジトリを渡して「モダナイズしたい」と伝えると、
まずコードベース全体をざっと読んで、移行方針をまとめて出してきた。

それを見て「ここはこうしたい」「これは後回しでいい」と微調整してから実装に入る、という流れ。
ファイル操作もビルド実行もエラー修正も全部ターミナル内で完結するのがとにかく楽だった。

### 機能追加

土台ができたので、せっかくだし機能も足すことにした。
これも Claude Code と相談しながら進めた。

「このサイト、もう少し良くするとしたら？」と聞いたら、

- SEO
- テーマ
- UX
- コンテンツ機能

の 4 カテゴリに分けて改善案を出してきた。
欲張って全部やることにした。

### Phase A: SEO

```ts
// app/layout.tsx
export const metadata: Metadata = {
    metadataBase: new URL(siteUrl),
    title: {
        default: siteTitle,
        template: `%s | ${siteTitle}`
    },
    description: siteDescription,
    openGraph: {
        /* ... */
    },
    twitter: { card: 'summary' },
    alternates: {
        types: { 'application/rss+xml': '/feed.xml' }
    }
}
```

Next.js 15 の Metadata API を使って、
Open Graph / Twitter Card / JSON-LD まわりを一通り整えた。

`sitemap.xml`、`robots.txt`、RSS フィードも route handler で静的生成している。

`output: 'export'` の制約で
`export const dynamic = 'force-static'` が必要だったのだけど、
ここは Claude Code がビルドエラーを見て勝手に直してくれた。

### Phase B: ダークモード

CSS カスタムプロパティを導入して、ライト / ダークの切り替えを実装した。

色を全部 `var(--color-bg)` みたいな変数に置き換えて、
`[data-theme="light"]` でライトテーマを定義する、よくあるやつ。

一番ハマったのは FOUC（テーマが一瞬チラつく問題）。
React のハイドレーション前にテーマが決まっていないと、どうしても起きる。

最終的には `<head>` にインラインスクリプトを入れて、
`localStorage` か `prefers-color-scheme` から先読みする形にした。

```html
<script>
    ;(function () {
        try {
            var t = localStorage.getItem('theme')
            if (t === 'light' || t === 'dark') {
                document.documentElement.setAttribute('data-theme', t)
            } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light')
            }
        } catch (e) {}
    })()
</script>
```

あと、コードブロックのコピーボタンも追加した。
`useEffect` で `pre > code` を探して、DOM に直接ボタンを差し込む方式。
この辺は割り切ってやっている。

### Phase C: UX 改善

細かいけど、あると嬉しいやつ。

- **目次**
  `rehype-slug` + `IntersectionObserver` でアクティブ見出しをハイライト
- **読了時間**
  日英混在なので 600 文字 / 分でざっくり計算
- **前後記事ナビゲーション**
- **スクロールトップボタン**
  `opacity` と `pointer-events` でフェード制御

地味だけど、全部あると体験はかなり良くなる。

### Phase D: 検索とシェア

検索は [fuse.js][fuse] を採用した。

ビルド時に `/search-index.json` を生成して、
⌘K で開くモーダルからファジー検索できるようにしている。

```ts
const loadIndex = useCallback(() => {
    if (indexRef.current) {
        setIndexReady(true)
        return
    }
    fetch('/search-index.json')
        .then(r => r.json())
        .then((data: SearchItem[]) => {
            indexRef.current = new Fuse(data, {
                keys: ['title', 'excerpt', 'category'],
                threshold: 0.3
            })
            setIndexReady(true)
        })
}, [])
```

SNS シェアは X、はてブ、リンクコピーの 3 種類。
外部ライブラリは使わず、Intent URL と Clipboard API だけで済ませた。

### S3 の URL 直打ち問題

途中で「記事 URL を直接打つと 404 になる」問題に遭遇した。

S3 + CloudFront の静的ホスティングで、
`/2020-02-02` に対応するファイルが見つからないやつ。

原因は単純で、`trailingSlash: true` を入れていなかった。
出力を `2020-02-02/index.html` にしたら解決。
S3 のインデックス解決、完全に忘れてた。

### スタイル調整

機能が揃ったところで、記事本文のスタイルが気になり始めた。

元々 GitHub Markdown CSS をほぼそのまま使っていて、`.markdown-body-custom` で `font-size: 1.5rem` にオーバーライドしていた。実質 24px。でかい。

Zenn の記事ページを参考に、typography とスペーシングを全体的に見直した。

- 本文フォントサイズを 16px に (Zenn と同じ)
- `line-height` を 1.6 → 1.7 に
- 見出しの `margin-top` を `2.3em` に広げてセクション間を明確に
- h3 以下の `border-bottom` を削除
- 段落間を `p + p { margin-top: 1.5em }` で制御
- blockquote を左ボーダー 3px + グレーテキストのシンプルな形に
- インラインコードを `0.85em` に、コードブロックを `0.9em` に

色はそのまま、間隔とサイズだけ Zenn に寄せた形。
見た目の印象がかなり変わった。

### コードレビューも Claude Code に

実装が一通り終わったあと、差分全体のレビューも Claude Code に投げた。

3 回くらいに分けて見てもらって、こんな指摘が出てきた。

- flex レイアウトの残骸
- Clipboard API の例外処理漏れ
- 検索インデックスの無駄な再取得
- テーマ初期 state のズレによるちらつき
- フェードアニメーションが効かない実装

自分で書いたコードを自分でレビューすると、やっぱり見落とす。
第三者（AI）の目が入るのは思った以上に効く。



### 振り返り

今回やってみて一番しっくりきたのは、

> **方向性は自分で決めて、実装の細部を任せる**

という使い方だった。

全部丸投げするとズレるし、
一行ずつ指示すると逆に疲れる。

計画を一緒に考えて、実装は任せて、最後にレビューする。
この距離感がちょうどよかった。

5 年放置していたブログが、
気づけばダークモードも検索もあるそれっぽい構成になった。

これでまた何か書くかというと……どうだろう。
でも少なくとも、この記事を書くきっかけにはなった。

それで十分、ということにしておく。

もし次やるなら、

- 記事ごとの感想メモ
- 書いた当時の自分コメント

とか入れても面白そうだな、と思っている。
やるかどうかは、未来の自分次第。

[claude-code]: https://docs.anthropic.com/en/docs/claude-code
[fuse]: https://www.fusejs.io/
